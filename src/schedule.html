<main id="schedule">
  <!-- The display: none will be automatically removed once the details are filled in -->
  <div id="ms-schedule-info" style="display: none">
    <h1>Hi <span id="ms-participant"></span></h1>
    <p>You have been invited to a meeting by <span class="text-emp" id="ms-organizer"></span>.</p>
    <blockquote><span id="ms-description"></span></blockquote>
    <p><span id="ms-regularity"></span></p>
    <p><span id="ms-timezone"></span></p>
  </div>

  <div>
    <h2>Suggested time slots</h2>
    <p>Based on your availability and preferences, we have selected the following time slots for you.</p>
    <div id="ms-schedule-suggested">
      <!-- This will be generated using js -->
    </div>
  </div>

  <div id="ms-schedule-container">
    <h2>Available time slots</h2>
    <table id="ms-schedule-calendar">
      <!-- Due to the complexity of the table's html, it will be generated using js and placed here -->
    </table>
  </div>
</main>

<script>
  // On page load, get the invitation parameters from the url
  $(document).ready(function () {
    // Get the invitation parameters from the url
    const urlParams = new URLSearchParams(window.location.search);
    let json = urlParams.get('invitation');

    if (json === null) {
      // Redirect to home page
      // window.location.href = "/";

      // For testing purposes, use debug invitation
      json = btoa(JSON.stringify(DEBUG_INVITATION))
    }

    // Json is in base64 format, decode it
    const decodedJson = atob(json);

    // Parse the invitation object
    /** @type {Invitation} */
    const inv = JSON.parse(decodedJson);

    // Fill in information
    $("#ms-participant").text(inv.participant);
    $("#ms-organizer").text(inv.organizer);
    $("#ms-description").text(inv.description);
    const regularity = {
      'once': 'This is a one-time meeting, please select a time slot that works best for you.',
      'daily': 'This is a recurrent daily meeting, please select a time slot that works best for you.',
      'weekly': 'This is a recurrent weekly meeting, please select a time slot that works best for you.',
    }
    $("#ms-regularity").text(regularity[inv.regularity]);

    // Check if time zones match
    if (inv.timezone === localTimezone) {
      $("#ms-timezone").text("Your time zone matches the organizer's time zone.");
    } else {
      $("#ms-timezone").text(`The organizer's time zone is ${inv.timezone}, the calendar below has been automatically converted to your time zone.`);
    }

    // Show the page
    $("#ms-schedule-info").css("display", "block");

    // Calculate days for the calendar
    const nDays = inv.availability.length

    // Get suggested times: Find two random time slots that are available
    const suggestedPool = [];
    for (let day = 0; day < nDays; day++) {
      for (let interval = 0; interval < 24 * 4; interval++) {
        // Ignore non-available intervals
        const avail = inv.availability[day][interval]
        if (avail === 0) continue;

        let end = interval + 1;
        while (end < 24 * 4 && inv.availability[day][end] !== 0) end++;

        // Check if the interval is long enough
        if (end - interval < inv.duration / 15) continue;

        // Add to the pool
        suggestedPool.push({day, interval});

        // Skip to the next duration
        interval += inv.duration / 15;
      }
    }

    // Pick two random time slots from the pool, show them as cards
    const suggested = shuffle(suggestedPool).slice(0, 2);
    let tmpHtml = '';
    for (const {day, interval} of suggested) {
      // Get the date and time
      const date = (inv.regularity === 'once') ? moment(inv.startDate).add(day, 'days').format('ddd, MMM D')
          : `Every ${moment().day(day).format('dddd')}`;
      const time = `at ${moment().hour(Math.floor(interval / 4)).minute((interval % 4) * 15).format('h:mm A')}`;

      tmpHtml += `
<div class="suggested-card" data-day="${day}" data-interval="${interval}">
  <div>
    <span class="date">${date}</span>
    <span class="time">${time}</span>
  </div>
  <button class="emp">Select</button>
</div>`;
    }
    $("#ms-schedule-suggested").html(tmpHtml);

    // Generate the available time slot view
    // This should be a grid of n days * 24 (1-hour interval) cells
    // Each column is a day, each row is an 1-hour interval
    // This table is just a grid
    // Availability is overlayed as absolute positioned divs inside the td
    tmpHtml = '<tr id="ms-schedule-header"><th></th>';
    for (let day = 0; day < nDays; day++) {
      if (inv.regularity === 'once')
        tmpHtml += `<th>${moment(inv.startDate).add(day, 'days').format('ddd, MMM D')}</th>`;
      else if (inv.regularity === 'weekly')
        tmpHtml += `<th>${moment().day(day).format('ddd')}</th>`;
    }
    tmpHtml += '</tr>';

    // Fill 1-hour grid
    for (let hour = 0; hour < 24; hour++) {
      tmpHtml += `<tr><td class="time">${hour}:00</td>`;

      for (let day = 0; day < nDays; day++) {
        tmpHtml += `<td class="day" data-day="${day}" data-hour="${hour}"></td>`;
      }
      tmpHtml += '</tr>';
    }
    $("#ms-schedule-calendar").html(tmpHtml);

    const preferences = {
      3: 'High',
      2: 'Medium',
      1: 'Low',
    }

    // Find continuous intervals of availability and inject each into the calendar
    for (let day = 0; day < nDays; day++) {
      // 15-minute intervals
      for (let interval = 0; interval < 24 * 4; interval++) {
        // Ignore non-available intervals
        const avail = inv.availability[day][interval]
        if (avail === 0) continue;

        // Find the end of the interval
        let end = interval + 1;
        while (end < 24 * 4 && inv.availability[day][end] === avail) end++;

        // Calculate the height as a percentage of the 1-hour td block
        let h = (end - interval) * 100 / 4;

        console.log(`day: ${day}, interval: ${interval}, end: ${end}, avail: ${avail}, h: ${h}%`)

        // Add a div under the td of the starting interval
        const td = $(`td[data-day="${day}"][data-hour="${Math.floor(interval / 4)}"]`);
        console.log(td)
        td.append(`<div class="avail av${avail}" style="height: ${h}%;">${preferences[avail]}</div>`);

        // Skip the rest of the interval
        interval = end - 1;
      }
    }

  });
</script>