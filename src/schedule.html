<main id="schedule">
  <!-- The display: none will be automatically removed once the details are filled in -->
  <div id="ms-schedule-info" style="display: none">
    <h1>Hi <span id="ms-participant"></span></h1>
    <p>You have been invited to a meeting by <span class="text-emp" id="ms-organizer"></span>.</p>
    <blockquote><span id="ms-description"></span></blockquote>
    <p><span id="ms-regularity"></span></p>
    <p><span id="ms-timezone"></span></p>
  </div>

  <table id="ms-schedule-calendar">

  </table>
</main>

<script>
  // On page load, get the invitation parameters from the url
  $(document).ready(function() {
    // Get the invitation parameters from the url
    const urlParams = new URLSearchParams(window.location.search);
    const json = urlParams.get('invitation');

    if (json === null) {
        // Redirect to home page
        window.location.href = "/";
    }

    // Json is in base64 format, decode it
    const decodedJson = atob(json);

    // Parse the invitation object
    /** @type {Invitation} */
    const inv = JSON.parse(decodedJson);

    // Fill in information
    $("#ms-participant").text(inv.participant);
    $("#ms-organizer").text(inv.organizer);
    $("#ms-description").text(inv.description);
    const regularity = {
        'once': 'This is a one-time meeting, please select a time slot that works best for you.',
        'daily': 'This is a recurrent daily meeting, please select a time slot that works best for you.',
        'weekly': 'This is a recurrent weekly meeting, please select a time slot that works best for you.',
    }
    $("#ms-regularity").text(regularity[inv.regularity]);

    // Check if time zones match
    if (inv.timezone === localTimezone) {
        $("#ms-timezone").text("Your time zone matches the organizer's time zone.");
    } else {
        $("#ms-timezone").text(`The organizer's time zone is ${inv.timezone}, the calendar below has been automatically converted to your time zone.`);
    }

    // Show the page
    $("#ms-schedule-info").css("display", "block");

    // Calculate days for the calendar
    const nDays = inv.availability.length

    // Generate the available time slot view
    // This should be a grid of n days * 24 * 4 (15-minute intervals) cells
    // Each column is a day, each row is a 15-minute interval
    // The cells are colored based on the availability of the participant
    let tmpHtml = '<tr id="ms-schedule-header"><th></th>';
    for (let day = 0; day < nDays; day++) {
        if (inv.regularity === 'once')
            tmpHtml += `<th>${moment(inv.startDate).add(day, 'days').format('ddd, MMM D')}</th>`;
        else if (inv.regularity === 'weekly')
            tmpHtml += `<th>${moment(inv.startDate).add(day, 'days').format('ddd')}</th>`;
    }
    tmpHtml += '</tr>';
    for (let interval = 0; interval < 24 * 4; interval++) {
        tmpHtml += `<tr>`;
        if (interval % 4 === 0) {
            tmpHtml += `<td class="time" rowspan="4">${Math.floor(interval / 4)}:00</td>`;
        }
        for (let day = 0; day < nDays; day++) {
            const availability = inv.availability[day][interval];
            tmpHtml += `<td class="block avail-${availability}"></td>`;
        }
        tmpHtml += '</tr>';
    }
    $("#ms-schedule-calendar").html(tmpHtml);
  });
</script>