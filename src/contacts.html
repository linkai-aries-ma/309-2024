<main>
  <div id="contact-list">
    <div class="section-header">
      <h2>Contacts</h2>
      <p class="hide-select">Click on the contact you want to invite.</p>
    </div>

    <div class="contact">
      <img src="assets/azalea.jpg" alt="azalea-pfp">
      <div>
        <span>Azalea</span>
        <span>azalea@example.com</span>
      </div>
    </div>

    <div class="contact">
      <img src="assets/henry.jpg" alt="henry-pfp">
      <div>
        <span>Henry</span>
        <span>henry@example.com</span>
      </div>
    </div>

    <div class="contact">
      <img src="assets/will.jpg" alt="will-pfp">
      <div>
        <span>Will</span>
        <span>will@example.com</span>
      </div>
    </div>

    <div class="contact">
      <img src="assets/linkai.jpg" alt="linkai-pfp">
      <div>
        <span>LinKai</span>
        <span>linkai@example.com</span>
      </div>
    </div>

    <div class="button-group">
      <button onclick="showContactOverlay()">+</button>
      <button id="cont-done-button"
          class="emp" onclick="window.location.href='calendar.html'" style="display: none">Done</button>
    </div>
  </div>

  <div id="contact-overlay" class="overlay">
    <div>
      <h1>Add New Contact</h1>
      <label>
        <input type="text" name="contact-name" placeholder="Name">
      </label>
      <label>
        <input type="email" name="contact-email" placeholder="Email">
      </label>
      <button id="contact-submit" class="emp">Submit</button>
      <button id="contact-cancel" onclick="closeContactOverlay()">Cancel</button>
    </div>
  </div>

  <div id="meeting-overlay" class="overlay">
    <div>
      <h1>Meeting Details</h1>
      <label>
        <input type="text" name="Meeting Topic" placeholder="Topic">
      </label>
      <label>
        <textarea name="Meeting Description" placeholder="Description"></textarea>
      </label>
      <button id="switch-online-btn" class="alt">Online Meeting</button>
      <label class="in-person-only" style="display: none">
        <input type="text" name="Meeting Location" placeholder="Location">
      </label>
      <button id="meeting-submit" class="emp" onclick="closeMeetingOverlay()">Submit</button>
      <button id="meeting-cancel" onclick="closeMeetingOverlay()">Cancel</button>
    </div>
  </div>
</main>

<script>
  let showContactOverlay, closeContactOverlay
  let showMeetingOverlay, closeMeetingOverlay, _closeMeetingOverlay
  let forMeeting = null
  const params = new URLSearchParams(window.location.search)

  function init_contact(el) {
    const $el = $(el)

    // Check if the contact is already initialized
    if ($el.data('initialized')) return;

    // If we have select=1, append the "Send" button
    if (params.get("select") != null) {
      $el.append('<button class="emp send">Send</button>');

      // Add event listener to the send button
      $el.find(".send").click(e => {
        forMeeting = e.target;

        // Show meeting overlay
        showMeetingOverlay();
      });
    }

    // Append the "Delete" button
    $el.append('<button class="warn delete icon"><iconify-icon icon="fluent:delete-20-filled"></iconify-icon></button>');

    // Add event listener to the delete button
    $el.find(".delete").click(e => {
      if (!confirm("Are you sure you want to delete this contact?")) return;
      $(e.target).closest(".contact").remove();
    });

    // Add click event listener to toggle the "opened" class
    $el.click(e => {
      if ($(e.target).is("button")) return;
      $(e.currentTarget).toggleClass("opened");
    });

    // Mark the contact as initialized
    $el.data('initialized', true);
  }

  function addContact(name, email, pfp) {
    if (pfp == null) pfp = "https://gravatar.com/avatar/00000000000000000000000000000000"

    // Add the contact to the list
    $("#contact-list .button-group").before(`
      <div class="contact">
        <img src="${pfp}" alt="blank-pfp">
        <div>
          <span>${name}</span>
          <span>${email}</span>
        </div>
      </div>
    `)

    // Initialize the contact
    init_contact($("#contact-list .contact").last()[0])

    // Clear the input fields
    $("input[name=contact-name]").val("")
    $("input[name=contact-email]").val("")

    // Close the overlay
    closeContactOverlay()
  }

  $(document).ready(() => {
    [showContactOverlay, closeContactOverlay] = registerOverlay("#contact-overlay");
    [showMeetingOverlay, _closeMeetingOverlay] = registerOverlay("#meeting-overlay");
    closeMeetingOverlay = () => {
      _closeMeetingOverlay()

      // Change the text
      $(forMeeting).text("âœ“")

      // Scroll to bottom
      forMeeting.scrollIntoView({ behavior: "smooth", block: "end", inline: "nearest" })

      // Show the "Done" button
      $("#cont-done-button").css("display", "flex")
    }

    // Initialize contacts
    $("#contact-list .contact").each((i, el) => init_contact(el))

    // Add event listener to the "Submit" button for adding a new contact
    $("#contact-submit").click(() => {
      // Check if the user has entered a name and email
      const name = $("input[name=contact-name]").val()
      const email = $("input[name=contact-email]").val()

      if (name === "" || email === "") {
        alert("Please enter a name and email.")
      }

      // Add the contact
      addContact(name, email)
    })

    // Toggle online / in-person meeting
    $('#switch-online-btn').click(e => {
      const btn = $(e.target)
      if (btn.text() === "Online Meeting") {
        btn.text("In-Person Meeting")
        btn.removeClass("alt")
        $(".in-person-only").css("display", "flex")
      } else {
        btn.text("Online Meeting")
        btn.addClass("alt")
        $(".in-person-only").css("display", "none")
      }
    })
  })
</script>